<link rel="import" href="./../../components/format-number-behavior.html">
<link rel="import" href="./../../components/month-behavior.html">

<dom-module id="quota-manage">
	<template>
		<style is="custom-style" include="flex-style gl-color gl-size gl-table">
			.title {
				background-color: orange;
				padding: 8px 10px 8px 10px;
				color: white;
				font-size: 18px;
				text-align: left;
			}
			
			* {
				text-align: left;
                font-family: 'rsuregular', sans-serif;
				-webkit-font-smoothing: antialiased;
			}
			
			.number {
				text-align: right !important;
			}
			.font{
                font-family: 'CSChatThaiUI', sans-serif !important;
                -webkit-font-smoothing: antialiased;
            }
			header {
				font-size: 24px;
                padding: 20px;
			}
			.container{
                padding: 20px;
            }
			gl-form-panel-body {
				padding: 10px;
			}
            th,td{ 
                text-align: center;
                white-space: nowrap;
            }
            .flex-equal-justified {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }
            .pointer{
                cursor:pointer;
            }
            .saveData{
                --paper-input-container-input:{
                    text-align: right;
                }
            }
            .left{
                --paper-input-container-input:{
                    text-align: left !important;
                }
            }
            paper-button,th,td{
                 font-family: 'CSChatThaiUI', sans-serif !important;
                -webkit-font-smoothing: antialiased;
            }
            .footer{
                text-align: center;
                font-size: 18px;
                margin-top: 20px;
            }
		</style>
		<div>
			<section>
				<gl-form-panel set-padding="0px 0px 20px 0px">
					<div class="title">รายละเอียดการจัดสรรโควตา</div>
					<gl-form-panel-body set-padding="0px 0px 0px 0px" set-border="0px">
						<gl-grid-row width="{{getWidth}}">
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
								<gl-form-input label="ปีโควตา" class="saveData left" allowed-pattern="[0-9]" error-message="กรุณาใสปีโควตา" required placeholder="ใส่ปีโควตา" value="{{data.year}}"
									id="" name="" disabled$="{{checkStatus(status)}}"> 
                                </gl-form-input>
							</gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
                                <gl-combo-box class="saveData" label="ประเภทข้าว" items="{{typeRice}}" value="{{data.type_rice_id}}" placeholder="กรุณาเลือกประเภทข้าว"
                                item-label-path="type_rice_name_th" item-value-path="id" error-message="กรุณาเลือกประเภทข้าว" required></gl-combo-box>
							</gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]">
								<gl-form-input class="mathData saveData" id="sum" label="ยอดรวม" allowed-pattern="[0-9||,||.]" format-number="on" value="{{data.amount}}" always-float-label auto-validate error-message="กรุณาใสจำนวน" required>
                                     <div class="font" suffix>&nbsp;ตัน</div>
                                </gl-form-input>
							</gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
						</gl-grid-row>

                        <gl-grid-row width="{{getWidth}}">
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
							    <div class="font header" style="text-align: left">
                                    <gl-form-input label="ตามปริมาณและมูลค่าที่ส่งออกในโควตา EU" value="100%"></gl-form-input>
                                </div>
							</gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
                                <div class="font header">
                                     <gl-form-input label="ตามปริมาณและมูลค่าที่ส่งออกทั้งหมด EU" value="0%"></gl-form-input>
                                </div>
								<!--<div class="font header" style="text-align: right">100%</div>-->
							</gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
						</gl-grid-row>

                        <gl-grid-row width="{{getWidth}}">
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,6]]">
							    
							</gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]">
								<!--<div class="font header">0%</div>-->
							</gl-grid-col>
							<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
						</gl-grid-row>

                          <div class="font footer">หมายเหตุ : ในช่องปริมาณ(ตัน)สามารถปรับเปลี่ยนได้</div>

						<article style="margin-top:10px; overflow-x:auto;">
							<table class="gl-table-default" id="[[index]]">
                                <thead>
								<tr>
									<th>จำนวนงวด</th>
                                    <th style="text-align: center;">เดือน</th>
									<th style="text-align: right;">สัดส่วน % </th>
                                    <th style="text-align: right;">ปริมาณ (ตัน)</th>
									<th></th>
								</tr>
                                </thead>
                                <tbody>
								<template is="dom-repeat" items="{{data.quantity}}">
									<tr>
										<td>งวดที่ :{{count(index)}}</td>
                                        <td>
                                         <gl-combo-box label="" class="saveData" style="margin-top: -21px;" items="{{getMonth()}}" value="{{item.month}}"
                                         item-label-path="name" item-value-path="id" error-message="กรุณาเลือกเดือน" required></gl-combo-box>
                                        </td>
										<td>
											<gl-form-input label="" class="mathData number saveData" maxlength="3"  allowed-pattern="[0-9]" error-message="กรุณาใสจำนวน" value="{{item.percent}}" required no-label-float>
                                                <div suffix>&nbsp;%</div>
                                            </gl-form-input>
										</td>
										<td>
											<gl-form-input label="" class="saveData" value="{{item.weigth}}" format-number="on" on-input="weightUpdate"
												index="{{index}}" required id="{{index}}" allowed-pattern="[0-9||,||.]" error-message="กรุณาใสจำนวน" no-label-float></gl-form-input>
										</td>
										<td>
											<paper-button on-tap="_delPeriod" index="[[index]]" item="{{item}}">
												<iron-icon icon="delete"></iron-icon>
											</paper-button>
										</td>
									</tr>
                                 </tbody>
								</template>
                                 <tbody>
								<tr class="pointer" on-tap="_addPeriod">
                                    <td colspan="5">	
                                        <paper-button>
											<iron-icon icon="add"></iron-icon> เพิ่มงวด
                                        </paper-button>
                                    </td>
								</tr>
                                 </tbody>
                                <thead>
								<tr>
									<th colspan="2">ปริมาณโควตารวม :{{mathQuantity(data.quantity.*)}} ตัน</th>
                                    <th></th>
                                    <th></th>
									<th>
										<paper-button hidden$="{{hide}}" raised class="gl-btn-primary" on-tap="_math">คำนวณ</paper-button>
									</th>
								</tr>
                                </thead>
							</table>
						</article>
					</gl-form-panel-body>
				</gl-form-panel>
			</section>

            <section>
                <div class="horizontal flex-equal-justified">
                    <div style="margin-left:10px;">
                        <paper-button hidden$="{{!checkStatus(status)}}" on-tap="_confirmedDel"><iron-icon icon="delete"></iron-icon>&nbsp;ลบปีโควตา</paper-button>
                    </div>
                    <div style="margin-right:10px;">
                        <paper-button class="gl-btn-danger" hidden$="{{checkStatus(status)}}" on-tap="confirmClose" raised>ยกเลิก</paper-button>
                        <paper-button class="gl-btn-success" on-tap="getForm" raised>บันทึก</paper-button>
                    </div>
                    
                </div>
            </section>
            
		</div>
	</template>
	<script>
        Polymer({
            is: 'quota-manage',
            behaviors: [
                ReduxBehavior,
                FormatNumberBehavior,
                MonthBehavior
            ],
            properties:{
                data:{
                    statePath:'quota.dataSelect'
                },
                typeRice:{
                    statePath:'commonSystem.typeRice'
                }
            },
            count:function(index){
                return index+1;
            },
            weightUpdate:function(){
                this.weightStatus = true;
            },
            // quantity function 
            _addPeriod:function(){ 
                console.log(this.data.quantity);
                this.push('data.quantity',{
                    period:'',
                    month:'',
                    percent:'',
                    weigth:'',

                })
            },
            _delPeriod:function(e){
                var index = e.currentTarget.index;
                this.splice('data.quantity',index,1);
            },
            //  math function
            _math:function(){
                if(typeof this.data.amount == 'undefined' || this.data.amount == ''){
                    this.fire('toast',{status:'error',text:'แจ้งเตือน : กรุณาระบุยอดรวม !!',
                      callback:()=>{}
                     });
                    Polymer.dom(this.root).querySelectorAll('.mathData').map((item)=>{
                        item.validate();
                    })
                }
                else if(this.data.quantity.length == 0){
                    this.fire('toast',{status:'warning',text:'แจ้งเตือน : กรุณาเพิ่มงวด !!',
                      callback:function(){
                      }
                    });
                }
                else {  
                    this.data.quantity.map((item)=>{
                        if(item.weigth == "" || typeof item.weigth == "undefined"){
                            this._mathWeigth();
                        }
                        else if(item.percent == "" || typeof item.percent == "undefined"){
                            this._mathPercent();
                        }
                        else {
                            if(this.weightStatus == true){
                                this._mathPercent();
                                this.weightStatus = false;
                            }else {
                                this._mathWeigth();
                            }
                           
                        }
                    })
                }
            },
            _mathWeigth:function(){
                this.data.quantity.map((item,index)=>{
                    item.weigth = parseFloat(this.unFormat(this.data.amount)*parseFloat(item.percent))/100;
                    this.set('data.quantity.'+index+'.weigth',item.weigth);
                })
            },
            _mathPercent:function(){
                this.data.quantity.map((item,index)=>{
                    var amount = this.unFormat(this.data.amount);
                    var weigth = parseFloat(this.unFormat(item.weigth));
                    item.percent = (weigth*100)/amount;
                    this.set('data.quantity.'+index+'.percent',item.percent);
                })
            },
            mathQuantity:function(data){
                var num = 0;
                if(data.base.length != 0){
                    this.data.quantity.map((item)=>{
                        if(item.weigth != '' && typeof item.weigth != 'undefined'){
                            num += parseInt(item.weigth);
                        }
                    })
                }
                // if(isNaN(num) == true) num = 0;
                return this.formatNumber(num).toString();
            },
            getForm:function(){
                var newData = {
                    amount : this.unFormat(this.data.amount),
                    year : parseInt(this.data.year),
                    type_rice_id : this.data.type_rice_id,
                    quantity : this.data.quantity.map((item)=>{
                        var newItem = {
                            month : parseInt(item.month),
                            percent : parseInt(item.percent),
                            period : i++,
                            weigth : parseFloat(item.weigth)
                        }
                        return newItem;
                    })
                }
                if(typeof this.data.id == 'undefined'){
                    this.dispatchAction('QUOTA_INSERT',newData);
                }
                else{
                    newData.id = this.data.id;
                    this.dispatchAction('QUOTA_UPDATE',newData);
                }        
            },
            _confirmedDel:function(){
                if(typeof this.data.id != 'undefined'){
                    this.fire('toast',{ 
                    status:'dialog',
                    text:'ต้องการลบข้อมูลใช่หรือไม่ ?',
                    confirmed:this.delData.bind(this), 
                    })
                }
            },
            delData:function(check){
                if(check == true){
                    this.dispatchAction('QUOTA_DELETE',this.data)
                }
            }


        });
    </script>
</dom-module>